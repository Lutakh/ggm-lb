<%- include('partials/header') %>

<nav id="desktop-sidebar">
    <a href="/" class="sidebar-btn" data-target="home">
        <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
        <span>Home</span>
    </a>
    <a href="#" class="sidebar-btn" data-target="add-update-section">
        <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
        <span>Add / Update</span>
    </a>
    <a href="#" class="sidebar-btn" data-target="players-leaderboard-section">
        <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
        <span>Players</span>
    </a>
    <a href="#" class="sidebar-btn" data-target="teams-leaderboard-section">
        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-2-9h4v-2h-4v2zm0 4h4v-2h-4v2z"/></svg>
        <span>Teams</span>
    </a>
    <a href="#" class="sidebar-btn" data-target="guilds-leaderboard-section">
        <svg viewBox="0 0 24 24"><path d="M12 3L4 9v12h16V9l-8-6zm0 2.62L17.19 9H6.81L12 5.62zM6 19v-8.45l6 4.5 6-4.5V19H6z"/></svg>
        <span>Guilds</span>
    </a>
    <a href="#" class="sidebar-btn" data-target="perilous-trials-section">
        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
        <span>Perilous Trials</span>
    </a>
    <a href="#" class="sidebar-btn" data-target="daily-quests-section">
         <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1s-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
         <span>Daily Quests</span>
    </a>
</nav>

<main>
    <%- include('partials/top-bar') %>

    <div id="add-update-section" class="main-section card">
        <h2>Add / Update a Character</h2>
        <form id="player-form" action="/add-player" method="POST">
            <div id="player-image-container"></div>
            <div class="form-step-1">
                <div id="player-selection-ui">
                     <div id="player-name-display">No player selected</div>
                    <input type="hidden" name="name" id="name-input-hidden">
                </div>
                <button type="button" id="open-player-select-btn" class="action-btn-main">Select Player</button>
            </div>
            <div id="form-details">
                <select id="class-select" name="pClass">
                    <option value="" disabled selected>Class</option>
                    <option value="Swordbearer">Swordbearer</option>
                    <option value="Acolyte">Acolyte</option>
                    <option value="Wayfarer">Wayfarer</option>
                    <option value="Scholar">Scholar</option>
                    <option value="Shadowlash">Shadowlash</option>
                </select>
                <input id="cp-input" type="text" name="cp" placeholder="Combat Power (e.g., 554k)" required>
                <select id="guild-select" name="guild"><option value="" selected>Guild (Optional)</option><% guilds.forEach(name => { %><option value="<%= name %>"><%= name %></option><% }); %></select>
                <div class="admin-team-select">
                    <select id="team-select" name="team"><option value="" disabled selected>Team</option><% allTeamNames.forEach(name => { %><option value="<%= name %>"><%= name %></option><% }); %><option value="No Team">No Team</option></select>
                </div>
                <input type="text" name="discord_user_id" id="discord-user-id-input" placeholder="Discord User ID (For Notifs)">
                <div id="time-slots-container">
                    <label>Play Hours <span id="local-timezone-note"></span></label>
                </div>
                <button type="button" id="add-slot-btn">+ Add Time Slot</button>
                <input id="notes-input" type="text" name="notes" placeholder="Personal Notes">
                <button id="submit-btn" type="submit" disabled>Submit Character</button>
            </div>
        </form>
        <% if (notification) { %><div class="notification"><p><%= notification %></p></div><% } %>
    </div>

    <div id="players-leaderboard-section" class="main-section card">
        <%- include('partials/players-leaderboard') %>
    </div>

   <div id="teams-leaderboard-section" class="main-section card">
        <%- include('partials/teams-leaderboard') %>
    </div>
    <div id="guilds-leaderboard-section" class="main-section card">
        <%- include('partials/guilds-leaderboard') %>
    </div>
    <div id="perilous-trials-section" class="main-section card">
        <%- include('partials/perilous-trials') %>
    </div>
    <div id="daily-quests-section" class="main-section card">
        <%- include('partials/daily-quests') %>
    </div>
</main>

<%# --- MODALS --- %>

<div id="player-select-modal-backdrop" class="player-select-modal-backdrop"></div>
<div id="player-select-modal" class="player-select-modal">
    <div class="player-select-modal-header">
        <h3>Select or Create a Player</h3>
        <button type="button" class="player-select-close-btn">&times;</button>
    </div>
     <div class="player-select-controls">
        <input type="text" id="player-filter-input" placeholder="Filter or type new name..." autocomplete="off">
        <button type="button" id="create-new-player-btn" class="action-btn-main">Create New</button>
    </div>
    <div id="player-select-list" class="player-select-list">
    </div>
</div>

<%# Admin Modal Structure - CORRECTION ICI : Suppression des conteneurs en double %>
<%- include('partials/admin-modal') %>

<%# Notes Modal Structure %>
<div id="notes-modal-backdrop" class="player-select-modal-backdrop"></div>
<div id="notes-modal" class="player-select-modal">
    <div class="player-select-modal-header">
        <h3 id="notes-modal-title">Notes</h3>
        <button type="button" id="notes-modal-close-btn" class="player-select-close-btn">&times;</button>
    </div>
    <div id="notes-modal-body" style="padding: 20px 25px; white-space: pre-wrap; line-height: 1.6;">
    </div>
</div>

<%# Player Detail Modal Structure %>
<div id="player-detail-modal-backdrop" class="player-select-modal-backdrop"></div>
<div id="player-detail-modal" class="player-select-modal">
    <div class="player-select-modal-header">
        <h3 id="player-detail-modal-title">Player Details</h3>
        <button type="button" id="player-detail-modal-close-btn" class="player-select-close-btn">&times;</button>
    </div>
    <div id="player-detail-modal-body">
    </div>
</div>

<%# Team Detail Modal Structure %>
<div id="team-detail-modal-backdrop" class="player-select-modal-backdrop"></div>
<div id="team-detail-modal" class="player-select-modal">
    <div class="player-select-modal-header">
        <h3 id="team-detail-modal-title">Team Details</h3>
        <button type="button" id="team-detail-close-btn" class="player-select-close-btn">&times;</button>
    </div>
    <div id="team-detail-modal-body">
    </div>
</div>

<%# Guild Detail Modal Structure %>
<div id="guild-detail-modal-backdrop" class="player-select-modal-backdrop"></div>
<div id="guild-detail-modal" class="player-select-modal">
    <div class="player-select-modal-header">
        <h3 id="guild-detail-modal-title">Guild Details</h3>
        <button type="button" id="guild-detail-close-btn" class="player-select-close-btn">&times;</button>
    </div>
    <div id="guild-detail-modal-body">
    </div>
</div>

<%# Nav Modal Structure %>
<div id="nav-modal-backdrop" class="player-select-modal-backdrop"></div>
<div id="nav-modal" class="player-select-modal">
    <div class="player-select-modal-header">
        <h3>Navigation</h3>
        <button type="button" id="nav-modal-close-btn" class="player-select-close-btn">&times;</button>
    </div>
    <div id="nav-modal-content">
    </div>
</div>

<%# Filters Modal Structure %>
<div id="filters-modal-backdrop" class="player-select-modal-backdrop"></div>
<div id="filters-modal" class="player-select-modal">
  <div class="player-select-modal-header">
    <h3>Player Filters</h3>
    <button type="button" id="filters-modal-close-btn" class="player-select-close-btn">&times;</button>
    </div>
    <div class="filters-modal-body">
        <%# Filters content here %>
        <div class="filter-group-modal filters-modal-class-filter"> <%# ... %> </div>
        <div class="filter-group-modal"> <%# ... CP ... %> </div>
        <div class="filter-group-modal"> <%# ... Guild ... %> </div>
        <div class="filter-group-modal"> <%# ... Team ... %> </div>
        <div class="filter-group-modal"> <%# ... PT Progress ... %> </div>
    </div>
</div>

<%# PT Help Modal Structure %>
<div id="pt-help-modal-backdrop" class="player-select-modal-backdrop"></div>
<div id="pt-help-modal" class="player-select-modal">
    <div class="player-select-modal-header">
        <h3>Perilous Trial - Help</h3>
        <button type="button" id="pt-help-close-btn" class="player-select-close-btn">&times;</button>
    </div>
    <div id="pt-help-modal-body"> <%# ... Help content ... %> </div>
</div>

<%# PT Filters Modal Structure %>
<div id="pt-filters-modal-backdrop" class="player-select-modal-backdrop"></div>
<div id="pt-filters-modal" class="player-select-modal">
    <div class="player-select-modal-header">
        <h3>PT Filters</h3>
        <button type="button" id="pt-filters-modal-close-btn" class="player-select-close-btn">&times;</button>
    </div>
    <div class="filters-modal-body"> <%# ... PT Filters content ... %> </div>
</div>

<%# DQ Help Modal Structure %>
<div id="dq-help-modal-backdrop" class="player-select-modal-backdrop"></div>
<div id="dq-help-modal" class="player-select-modal">
    <div class="player-select-modal-header">
        <h3>Daily Quests & Stamina - Help</h3>
        <button type="button" id="dq-help-close-btn" class="player-select-close-btn">&times;</button>
    </div>
    <div id="dq-help-modal-body">
        <strong>Daily Quests</strong>
        <p>This section allows you to track the completion of your daily quests for up to 3 characters. Simply check the box next to a quest when you complete it in-game. The status is saved per player for the current day (resets at 09:00 UTC).</p>

        <strong>Stamina</strong>
        <p>Stamina is required for various in-game activities. It regenerates over time.</p>
        <ul>
            <li><strong>Max Stamina:</strong> You can hold a maximum of 60 Stamina.</li>
            <li><strong>Regeneration:</strong> You gain +1 Stamina every 24 minutes. Regeneration stops when you reach the maximum.</li>
            <li><strong>Tracking:</strong> The tracker shows your current Stamina (calculated based on the last update) and allows you to manually input the current value if needed.</li>
        </ul>

        <strong>"Next in" Timer</strong>
        <p>This timer shows the approximate time remaining (minutes and seconds) until you gain your next Stamina point. You can manually adjust this timer along with the current Stamina value for accurate tracking, especially after spending Stamina in-game.</p>
        <ul>
            <li>Enter the current Stamina value displayed in-game.</li>
            <li>Enter the remaining minutes and seconds shown on the in-game timer until the next point.</li>
            <li>The tracker will automatically calculate and display the current stamina and time remaining based on your inputs.</li>
        </ul>

        <strong>Discord Notifications</strong>
        <p>You can receive Discord Direct Messages (DMs) when your Stamina reaches 40/60 and 60/60. This helps you avoid wasting regenerated Stamina.</p>
        <p>To enable notifications:</p>
        <ol>
            <li>Add or Update your character using the "Add / Update" section.</li>
            <li>Find your Discord User ID (see below).</li>
            <li>Enter your Discord User ID into the corresponding field in the form and submit.</li>
            <li>Ensure you allow Direct Messages from server members or the bot itself in your Discord privacy settings.</li>
        </ol>

        <strong>How to find your Discord User ID:</strong>
        <ol>
            <li>Open Discord.</li>
            <li>Go to User Settings (gear icon near your username).</li>
            <li>Go to the "Advanced" section.</li>
            <li>Enable "Developer Mode".</li>
            <li>Close settings.</li>
            <li>Right-click (or tap and hold on mobile) on your own username in any chat or server list.</li>
            <li>Select "Copy User ID".</li>
            <li>Paste this ID (it's a long number) into the character form.</li>
        </ol>
    </div>
</div>

<%# --- SCRIPTS JSON DATA --- %>
<script id="players-data" type="application/json"><%- JSON.stringify(players.map(p => ({id: p.id, name: p.name, class: p.class}))) %></script>
<script id="player-selector-data" type="application/json"><%- JSON.stringify(playerListForSelectors) %></script>

<%- include('partials/footer') %>