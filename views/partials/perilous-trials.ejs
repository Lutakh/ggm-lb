<div class="view-tabs"><h2>Perilous Trial Leaderboards</h2></div>

<div class="pt-main-controls">
    <div class="pt-selector-group">
        <label for="pt-select">Trial:</label>
        <select id="pt-select">
            <option value="global" selected>Global Ranking</option>
            <% perilousTrials.forEach(pt => {
                const isFilled = parseInt(pt.team_count) >= 50;
            %>
                <option value="<%= pt.id %>" class="<%= isFilled ? 'pt-filled' : '' %>">
                    <%= pt.name %> <%= isFilled ? '(50+)' : '' %>
                </option>
            <% }); %>
        </select>
    </div>
    <div id="pt-global-mode-selector" class="pt-selector-group" style="display: none;">
        <label for="pt-global-mode">Mode:</label>
        <select id="pt-global-mode">
            <option value="best" selected>Best Rank/PT</option>
            <option value="all">All Ranks</option>
        </select>
    </div>
</div>

<div class="mobile-pt-controls">
    <button id="open-pt-filters-btn" class="action-btn-main">PT Filters</button>
    <div class="pt-mobile-actions-right">
        <button id="pt-add-team-btn-mobile" class="action-btn-main admin-only" style="display: none;">Add</button>
        <button id="pt-help-btn-mobile" class="help-button">Help</button>
    </div>
</div>

<div class="controls desktop-pt-controls">
    <button id="open-pt-filters-btn-desktop" class="action-btn-main" style="display: none;">Filters</button>

    <div style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
        <button id="pt-add-team-btn-desktop" class="action-btn-main admin-only" style="display: none;">Add Team</button>
        <button id="pt-help-btn-desktop" class="help-button" style="margin-left: 0;">Help</button>
    </div>
</div>

<div class="leaderboard-legend">
    <div class="legend-item"><span class="class-tag class-swordbearer"></span> <span class="legend-full">Swordbearer</span><span class="legend-short">Swd</span></div>
    <div class="legend-item"><span class="class-tag class-acolyte"></span> <span class="legend-full">Acolyte</span><span class="legend-short">Aco</span></div>
    <div class="legend-item"><span class="class-tag class-wayfarer"></span> <span class="legend-full">Wayfarer</span><span class="legend-short">Way</span></div>
    <div class="legend-item"><span class="class-tag class-scholar"></span> <span class="legend-full">Scholar</span><span class="legend-short">Sch</span></div>
    <div class="legend-item"><span class="class-tag class-shadowlash"></span> <span class="legend-full">Shadowlash</span><span class="legend-short">Sha</span></div>
</div>

<table id="pt-leaderboard-table">
    <thead><tr><th>Rank</th><th>Team</th></tr></thead>
    <tbody></tbody>
</table>

<table id="pt-global-leaderboard-table" style="display: none;">
    <thead>
        <tr>
            <th class="rank-col">Rank</th>
            <th class="pt-global-player-col">Player</th>
            <th class="pt-global-cp-col">CP</th>
            <th>Points</th>
        </tr>
    </thead>
    <tbody>
    </tbody>
</table>

<div class="admin-actions" id="pt-admin-form-container" style="display: none;">
    <h3>Update Leaderboard</h3>
    <form id="pt-admin-form" action="/pt-leaderboard" method="POST">
        <input type="hidden" name="admin_password" class="admin-pass-input">

        <div class="pt-admin-form-row">
            <div class="filter-group" style="flex-grow: 1;">
                <label for="pt-id-input">Perilous Trial</label>
                <select id="pt-id-input" name="pt_id" required>
                    <option value="" disabled selected>Select PT</option>
                    <% perilousTrials.forEach(pt => {
                        const isFilled = parseInt(pt.team_count) >= 50;
                    %>
                        <option value="<%= pt.id %>" class="<%= isFilled ? 'pt-filled' : '' %>">
                            <%= pt.name %> <%= isFilled ? '(50+)' : '' %>
                        </option>
                    <% }); %>
                </select>
            </div>
            <div class="filter-group">
                <label for="pt-team-rank">Rank</label>
                <input type="number" name="rank" min="1" class="pt-team-rank-input" id="pt-team-rank" required>
            </div>
        </div>

        <div class="pt-player-inputs">
            <% for(let i = 0; i < 4; i++) { %>
            <div class="pt-player-entry-container">
                <label>Player <%= i + 1 %></label>
                <div class="pt-player-selection-ui">
                    <div class="pt-player-name-display" id="pt-player-display-<%= i %>">No player selected</div>
                    <input type="hidden" name="players[<%= i %>][name]" id="pt-player-name-hidden-<%= i %>">
                    <button type="button" class="pt-open-modal-btn action-btn-main" data-player-index="<%= i %>">Select</button>
                </div>
                <div class="pt-new-player-fields" id="pt-new-player-fields-<%= i %>">
                    <select name="players[<%= i %>][class]">
                        <option value="" disabled selected>Class</option>
                        <option value="Swordbearer">Swordbearer</option>
                        <option value="Acolyte">Acolyte</option>
                        <option value="Wayfarer">Wayfarer</option>
                        <option value="Scholar">Scholar</option>
                        <option value="Shadowlash">Shadowlash</option>
                    </select>

                    <div class="pt-guild-selection-ui" style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <div id="pt-guild-display-<%= i %>" class="pt-player-name-display" style="flex-grow: 1; font-style: italic;">Guild (Optional)</div>
                        <input type="hidden" name="players[<%= i %>][guild]" id="pt-guild-hidden-<%= i %>">
                        <button type="button" class="pt-select-guild-btn action-btn-main" data-player-index="<%= i %>">Select</button>
                    </div>

                    <input type="text" name="players[<%= i %>][cp]" placeholder="CP (e.g., 1.2M)">
                </div>
            </div>
            <% } %>
        </div>

        <button type="submit">Submit Team</button>
    </form>
</div>