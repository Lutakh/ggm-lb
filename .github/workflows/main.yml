# Nom du workflow qui apparaÃ®tra dans l'onglet "Actions" de GitHub
name: Deploy to Synology NAS

# DÃ©clencheur du workflow
on:
  push:
    branches:
      - main  # DÃ©clenche sur un push sur la branche main
      - dev   # DÃ©clenche sur un push sur la branche dev

# DÃ©finition des jobs Ã  exÃ©cuter
jobs:
  # Job pour le dÃ©ploiement
  deploy:
    # Nom du job
    name: Deploy to NAS
    # IMPORTANT : SpÃ©cifie que ce job doit s'exÃ©cuter sur votre runner auto-hÃ©bergÃ©
    runs-on: self-hosted

    # Ã‰tapes (steps) Ã  exÃ©cuter
    steps:
      # 1. Configurer la clÃ© SSH pour se connecter au NAS
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh/
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.NAS_IP }} >> ~/.ssh/known_hosts
        shell: bash

      # 2. DÃ©ployer sur l'environnement DEV si la branche est 'dev'
      - name: Deploy to Development
        if: github.ref == 'refs/heads/dev'
        run: |
          ssh ${{ secrets.NAS_USER }}@${{ secrets.NAS_IP }} "
            echo 'ðŸš€ DÃ©ploiement sur DEV...'
            cd /volume1/docker/ggm-lb-dev
            echo '1. Mise Ã  jour du code...'
            git pull
            echo '2. Reconstruction et redÃ©marrage des conteneurs Docker...'
            sudo /usr/local/bin/docker compose down
            sudo /usr/local/bin/docker compose up -d --build
            echo 'âœ… DÃ©ploiement DEV terminÃ©.'
          "
        shell: bash

      # 3. DÃ©ployer sur l'environnement PROD (S81) si la branche est 'main'
      - name: Deploy to Production
        if: github.ref == 'refs/heads/main'
        run: |
          ssh ${{ secrets.NAS_USER }}@${{ secrets.NAS_IP }} "
            echo 'ðŸš€ DÃ©ploiement sur PROD (S81)...'
            cd /volume1/docker/ggm-lb-s81
            echo '1. Mise Ã  jour du code...'
            git pull
            echo '2. Reconstruction et redÃ©marrage des conteneurs Docker...'
            sudo /usr/local/bin/docker compose down
            sudo /usr/local/bin/docker compose up -d --build
            echo 'âœ… DÃ©ploiement PROD (S81) terminÃ©.'
          "
        shell: bash

